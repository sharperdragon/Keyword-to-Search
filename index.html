<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anki Easy Search</title>
    <link rel="stylesheet" href="/Keyword-to-Search/static/style.css">
    <link rel="icon" href="/UWorld-ID-to-Anki-Tag/favicon.png" type="image/png">
</head>
<body>
    <div class="container">
        <h1>Keyword to Anki Search</h1>

        <div class="input-history-wrapper sticky-history">
            <!-- Input Field -->
            <div>
                <label for="input_ids">Keywords (comma-separated):</label>
                <textarea id="input_ids" rows="4" placeholder="e.g., anti-Jo1, coronary artery, BRCA1..."></textarea>
            </div>

            <!-- History Dropdown -->
            <div style="min-width: 220px; max-width: 300px;">
                <label for="history_select">History:</label>
                <select id="history_select" style="width: 100%;">
                    <option value="">-- Select from history --</option>
                </select>
            </div>
        </div>

        <!-- Buttons for Select All/Deselect All -->
        <div id="selection_buttons">
            <button id="select_all">Select All</button>
            <button id="deselect_all">Deselect All</button>
            <button id="copy_button">Copy to Clipboard</button>
        </div>

        <!-- Generated Questions -->
        <div id="question_list"></div>

        <!-- Output Section -->
        <label for="output_text">Output <span style="opacity:0.7">(paste into Anki browser)</span></label>
        <textarea id="output_text" rows="5" readonly></textarea>
    </div>

    <script>
        function debounce(func, delay = 300) {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), delay);
            };
        }

        const inputField = document.getElementById("input_ids");
        const questionList = document.getElementById("question_list");
        const outputText = document.getElementById("output_text");
        const selectAllButton = document.getElementById("select_all");
        const deselectAllButton = document.getElementById("deselect_all");
        const copyButton = document.getElementById("copy_button");
        const historySelect = document.getElementById("history_select");

        let lastSavedInput = "";

        // Update the question list dynamically when input changes
        inputField.addEventListener("input", debounce(() => {
            const val = inputField.value.trim();
            updateQuestionList();
            if (val && val !== lastSavedInput) {
                saveToHistory(val);
                lastSavedInput = val;
            }
        }, 300));

        // Event listener for Select All button
        selectAllButton.addEventListener("click", () => {
            toggleSelection(true);
            updateOutput();
        });

        // Event listener for Deselect All button
        deselectAllButton.addEventListener("click", () => {
            toggleSelection(false);
            updateOutput();
        });

        function updateQuestionList() {
            questionList.innerHTML = ""; // Clear previous list
            const inputIDs = inputField.value.trim();

            if (!inputIDs) {
                if (lastSavedInput !== "") {
                    saveToHistory("");
                    lastSavedInput = "";
                }
                return; // Do nothing if input is empty
            }

            const ids = [];
            const regex = /"([^"]+)"|([^,]+)/g;
            let match;
            while ((match = regex.exec(inputIDs)) !== null) {
                const item = match[1] ? `"${match[1].trim()}"` : match[2].trim();
                if (item) ids.push(item);
            }

            ids.forEach((id, index) => {
                const label = document.createElement("label");
                label.innerHTML = `
                    <input type="checkbox" value="${id}">
                    <span class="number">${index + 1})</span>
                    <span class="space"> </span> 
                    <span class="id">${id}</span>`;
                questionList.appendChild(label);
                questionList.appendChild(document.createElement("br"));
            });
            updateOutput();
        }

        function toggleSelection(selectAll) {
            const checkboxes = questionList.querySelectorAll("input[type='checkbox']");
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll;
                checkbox.dispatchEvent(new Event("change"));
            });
        }

        function updateOutput() {
            const selectedIDs = Array.from(document.querySelectorAll("#question_list input:checked"))
                                    .map(input => input.value);

            if (!selectedIDs.length) {
                outputText.value = "";
                return;
            }

            const outputParts = [];

            selectedIDs.forEach(entry => {
                const words = entry.trim().split(/\s+/).map(w => w.trim()).filter(w => w.length > 0);

                if (words.length === 1) {
                    outputParts.push(`(Text:*${words[0]}*)`);
                } else if (words.length > 1) {
                    const wordClauses = words.map(w => `(Text:*${w}*)`);
                    outputParts.push(`(${wordClauses.join(" ")})`);
                }
            });

            outputText.value = `(${outputParts.join(" OR ")})`;
        }

        questionList.addEventListener("change", updateOutput);

        copyButton.addEventListener("click", () => {
            outputText.select();
            outputText.setSelectionRange(0, 99999); // For mobile compatibility
            navigator.clipboard.writeText(outputText.value).then(() => {
                const val = inputField.value.trim();
                if (val && val !== lastSavedInput) {
                    saveToHistory(val);
                    lastSavedInput = val;
                }
                copyButton.textContent = "Copied!";
                setTimeout(() => (copyButton.textContent = "Copy to Clipboard"), 1500);
            });
        });
    </script>
</body>
</html>
